#+OPTIONS: ^:nil
#+EXPORT_EXCLUDE_TAGS: noexport
* CMS ETL Readout Board PCB :TOC:
  - [[#useful-links][Useful Links]]
  - [[#milestones][Milestones]]
  - [[#block-diagrams][Block Diagrams]]
  - [[#mechanical-outline][Mechanical Outline]]
  - [[#power][Power]]
  - [[#lpgbt-configuration][LPGBT Configuration]]
  - [[#test-points][Test points]]
  - [[#vtrx-i2c][VTRX+ I2C]]
  - [[#errata][Errata]]
  - [[#fusing-instructions][Fusing Instructions]]

** Useful Links
- Latest RB Schematics - [[https://gitlab.cern.ch/cms-etl-electronics/readout-board-pcb/uploads/183954f3a47f967752902acf8ae9c3d3/ETL_RB_V1.6.PDF][ETL_RB_V1.6.PDF]]
- Latest RB Gerbers:  [[https://gitlab.cern.ch/cms-etl-electronics/readout-board-pcb/uploads/5678ebf45c38e1c627c98f56c8df58fa/ETL_RB_V1.6.zip][ETL_RB_V1.6.zip]]
- Latest RB Project Archive - [[https://gitlab.cern.ch/cms-etl-electronics/readout-board-pcb/uploads/25dc68e87a1a2c3de5a3411c434b7c02/ETL_RB__11-2-2020_9-17-11_AM_.zip][ETL_RB__11-2-2020_9-17-11_AM_.zip]]
- Mr. Wu's File Stash - [[http://physics.bu.edu/~wusx/download/ETL_RB/]]
- Datasheets:
  + LpGBT Manual - [[https://lpgbt.web.cern.ch/lpgbt/manual/][LpGBT Manual]]
  + GBT-SCA Manual - [[https://espace.cern.ch/GBT-Project/GBT-SCA/Manuals/GBT-SCA_Manual_2019.002.pdf][GBT-SCA Manual]]
  + LINPOL12 Datasheet - [[https://project-dcdc.web.cern.ch/public/Documents/linPOL12V%20datasheetV3.3.pdf][LinPOL12V]]
  + VTRX+ Application Note: [[https://edms.cern.ch/ui/file/2149674/1/VTRxPlusApplicationNote.pdf][VTRxPlusApplicationNote.pdf]]
  + VTRX+ Specification: [[https://edms.cern.ch/ui/file/1719329/1/VTRxPlus_spec_v2.4.pdf][VTRxPlus_spec_v2.4.pdf]]
  + VTRX+ LDD Specs: [[https://edms.cern.ch/ui/file/1719330/1/VLplus_quadLDD_spec_v1.2_prototypes.pdf][VLplus_quadLDD_spec_v1.2_prototypes.pdf]]
- TDR - [[https://cds.cern.ch/record/2667167/files/CMS-TDR-020.pdf][CMS-TDR-020]]
*** Relevant Presentations
- 2019/05/13 - [[https://indico.cern.ch/event/820512/contributions/3429658/attachments/1842929/3023621/ETL-Cabling-S_Los-May13-2019.pdf][Update on Power board and Patch Panel-0]] (Sergey V.)
- 2020/03/09 - [[https://indico.cern.ch/event/902328/contributions/3798257/attachments/2008611/3355343/2020-03-09_LV_scheme.pdf][ETL LV powering scheme]] (Natalia K.)
- 2020/04/05 - [[https://indico.cern.ch/event/906805/contributions/3815774/attachments/2016073/3369701/2020-04-05-ETL-RBv2-Boston.pdf][ETL Readout Board v2]] (Andy P.)
- 2020/04/27 - [[https://indico.cern.ch/event/912420/contributions/3837314/attachments/2026902/3391190/Andy_Liu_-_Emulator_v1.1.pdf][EIE Dataformat]] (Andy L.)
- 2020/06/02 - [[https://indico.cern.ch/event/931796/contributions/3915833/attachments/2061731/3458677/ETROC2-power-update-v1.pdf][ETROC Power consumption]] (Andy P.)
- 2020/07/13 - [[https://indico.cern.ch/event/939160/contributions/3946133/attachments/2073487/3481402/20200713_readout_board_interfaces.pdf][Readout Board Interfaces]] (Andy P.)
- 2020/08/31 - [[https://indico.cern.ch/event/950697/contributions/3993986/attachments/2093983/3519322/20200831_readout_board_v2.pptx.pdf][Readout Board v2 Update]] (Andy P.)
- 2020/08/31 - [[https://indico.cern.ch/event/950697/contributions/3993988/attachments/2094005/3519146/ETL-PowerConversion-S_Los-Aug31-2020.pdf][Power Board Status]] (Sergey V.)
- 2021/03/01 - [[https://indico.cern.ch/event/1012776/contributions/4250636/attachments/2199248/3719226/20210301_etl_readout_board.pptx.pdf][Readout Board v2 Update]] (Andy P.)
- 2021/05/10 - [[https://indico.cern.ch/event/1037766/contributions/4357988/attachments/2242193/3801880/Emulator%20updates%2020210510%20V3.pdf][Emulator v1 Update]] (Andy L.)
- 2021/05/17 - [[https://indico.cern.ch/event/1039531/contributions/4366460/attachments/2245627/3808234/ETL-MultyChannel-bPOL-Proto-S_Los-May17-2021.pdf][Power Board Status]] (Sergey L.)
** Milestones
- 2020/11/02 - Finish schematic and layout; Submit files to fab house
- 2020/12/08 - Receive readout boards from Pactron
- 2021/03/01 - Preliminary testing (LPGBT, elinks)
- 2021/03/18 - Working SCA GPIO Control
- 2021/03/23 - Working ADC voltage readings
- 2021/05/19 - Working SCA I2C master
** Block Diagrams
*** Data Flow
#+ATTR_HTML: :width 700px
[[file:docs/data-flow.svg]]
*** Module Connectivity
Full size: [[file:docs/module-connectivity.pdf]]
#+ATTR_HTML: :width 700px
[[file:docs/module-connectivity.svg]]
*** Power Distribution
#+ATTR_HTML: :width 700px
[[file:docs/power-distribution.svg]]
*** Control and Monitoring
#+ATTR_HTML: :width 700px
[[file:docs/ctrl-and-mon.svg]]
** Connectors/Interfaces :noexport:
** Mechanical Outline
#+attr_org: :width 700px
[[file:docs/mechanical-outline.png]]
** Power
*** Power Estimates

The readout board is expected to dissipate up to ~1.3W, along with some additional power for LINPOL conversion efficiency. Total power should be around 2W.  Details of the calculation follow.

*NOTE:* This calculation is for a configuration of *2tx + 1rx* (i.e. with a trigger path). The numbers are different if this is not the case (subtract roughly 0.6W for the LPGBT/VTRX).

|-----------------------------+------------------|
| Note                        | P (mW)           |
|-----------------------------+------------------|
| 1.2V LPGBT analog + digital | 1000             |
| 1.2V VTRX digital           | 30               |
| 2.5V VTRX analog            | 150 - 175        |
| 1.5V GBT-SCA                | 65.4 - 108       |
| LINPOL12 Loss               | 613 - 853        |
|-----------------------------+------------------|
| *Total*                     | *1858 - 2166 mW* |
|-----------------------------+------------------|

**** VTRX
[[https://edms.cern.ch/ui/file/1719329/1/VTRxPlus_spec_v2.4.pdf][VTRX+ Specification]] specifies:
- A supply current 2V5RX of 40mA
- A supply current 2V5TX of  15/ch @ End of life (30mA for a 2+1 configuration)
- A supply current 1V2D of 5+10/ch mA (25mA for a 2+1 configuration)

|---------+--------+----------------+----------------------------------------|
| Voltage | I (mA) |         P (mW) | Notes                                  |
|---------+--------+----------------+----------------------------------------|
| 2V5RX   |     40 |            100 | 40mA total                             |
| 2V5TX   |  20-30 |          50-75 | 15mA/ch at end of life (10mA to start) |
| 1V2     |     25 |             30 | 5+10mA/ch                              |
|---------+--------+----------------+----------------------------------------|
| *Total* |        | *180 - 205 mW* |                                        |
|---------+--------+----------------+----------------------------------------|

**** GBT-SCA
The GBT-SCA manual specifies power consumption of:

|--------------------------------+-------------------+-------------------|
| Supply                         | Typical (Maximum) | Power mW          |
|--------------------------------+-------------------+-------------------|
| 1V5 VDD core                   | 36 (63) mA        | 54 (94.5) mW      |
| 1V5 AVDD analog                | 0.5 (0.8) mA      | 0.75 (1.2) mW     |
| 1V5 DVDD Static supply current | 7.1 (8.2) mA      | 10.65 (12.3) mW   |
|--------------------------------+-------------------+-------------------|
| *Total*                        | *43.6 (72.0) mA*  | *65.4 (108.0) mW* |
|--------------------------------+-------------------+-------------------|

**** LPGBT
LPGBT power measurements can be found at https://espace.cern.ch/GBT-Project/LpGBT/Presentations/lpGBT20190903.pdf

Note that these numbers may change between v0 and v1 of the LPGBT.

Power consumption is dependent on the exact configuration, but we expect it should be <500mW

We expect up to 2 LPGBTs per board, so ~1W maximum.

**** LINPOL

Three LINPOL12 chips are used on board to provide 1.5V (GBT-SCA), and 2.5V (1 each for VTRX TX + RX).

For the 2.5V supply a voltage divider is formed by RR0510P-1541-D (1.54k) and RR0510P-4870-D (487R).
 - V=0.6*(1+1540/487)=2.497V

For the 1.5V supply a voltage divider is formed by RR0510P-6040-D (604R) and RR0510P-4020-D (402R).
 - V= 0.6*(1+604/402)=1.50V

We have some additional power loss in the LINPOL12 chips, which is dependent on the exact input voltage. Assuming 8V nominal, we would expect using the /MAXIMUM/ values:

|---------+-------------------------------------------|
| Supply  | Power mW                                  |
|---------+-------------------------------------------|
| 1V5     | (8-1.5)*(43.6 - 72) = (283 typ - 468 max) |
| 2V5 TX  | (8-2.5)*(20 - 30) = (110 start - 165 EOL) |
| 2V5 RX  | (8-2.5)*40 = 220                          |
|---------+-------------------------------------------|
| *Total* | *613 - 853 mW*                            |
|---------+-------------------------------------------|

** LPGBT Configuration

The DAQ and Trigger LPGBTs are arranged in a master-slave configuration, with the master LPGBT providing a clock and an I2C bus to the slave.

Both LPGBTs are configured by default in FEC12 10.24 Gbps mode, with jumpers available to select FEC5 or 5.12 Gbps modes. CHange of the mode affects both LPGBTs together.

|---------+--------------------------------------------------------|
| Jumpers | Description                                            |
|---------+--------------------------------------------------------|
| JMP1    | Install to set LPGBT MODE[2] to 0 (FEC12 → FEC5)       |
| JMP2    | Install to set LPGBT MODE[3] to 0 (data rate → 5 Gbps) |
|---------+--------------------------------------------------------|

A handy copy of the LPGBT mode table:

|------------+--------------+-------------+-------------|
| MODE [3:0] | Tx Data Rate | Tx Encoding | lpGBT Mode  |
|------------+--------------+-------------+-------------|
| 4’b0000    | 5 Gbps       | FEC5        | Off         |
| 4’b0001    | 5 Gbps       | FEC5        | Simplex TX  |
| 4’b0010    | 5 Gbps       | FEC5        | Simplex RX  |
| 4’b0011    | 5 Gbps       | FEC5        | Transceiver |
| 4’b0100    | 5 Gbps       | FEC12       | Off         |
| 4’b0101    | 5 Gbps       | FEC12       | Simplex TX  |
| 4’b0110    | 5 Gbps       | FEC12       | Simplex RX  |
| 4’b0111    | 5 Gbps       | FEC12       | Transceiver |
| 4’b1000    | 10 Gbps      | FEC5        | Off         |
| 4’b1001    | 10 Gbps      | FEC5        | Simplex TX  |
| 4’b1010    | 10 Gbps      | FEC5        | Simplex RX  |
| 4’b1011    | 10 Gbps      | FEC5        | Transceiver |
| 4’b1100    | 10 Gbps      | FEC12       | Off         |
| 4’b1101    | 10 Gbps      | FEC12       | Simplex TX  |
| 4’b1110    | 10 Gbps      | FEC12       | Simplex RX  |
| 4’b1111    | 10 Gbps      | FEC12       | Transceiver |
|------------+--------------+-------------+-------------|

** Test points

** VTRX+ I2C
VTRX+ documentation does not specify the I2C address of the device, but the
laser driver spec has some details:
[[https://edms.cern.ch/ui/file/1719330/1/VLplus_quadLDD_spec_v1.2_prototypes.pdf]]

I checked the bonding diagram
([[https://edms.cern.ch/ui/file/2146792/1/CERN_VTRxPlus_V10_bonding.pdf]]) and the
address pins are not connected, so they use internal pull down.

The address then is 1010000 = 0x50

** Errata
1) KSC2223 footprint is incorrect
   - The footprint of the KSC2223 transistor is incorrect.
2) Incorrect assignment of e-fuse power
   - EFUSEPOWER (2.5V power to be applied only during fusing) is incorrectly
     connected to I2C configuration connector ~P1~, pin 9. Pin 9 is in fact the
     ~MODE3_1V25~ pin of the Rpi control toolkit, and should /not/ be connected to
     EFUSE power.
   - *The trace must be cut*.
3) Erroneous note about I2C addresses
   - The schematic features a note:
       #+begin_quote
     I2C ADDR6, ADDR5 and ADDR4 of ETROC2 must not be all 0 or all 1.
     pin 11 of P6, P8 and P10 sets ADDR2 of ETROC2
     pin 12 of P6, P8 and P10 sets ADDR3 of ETROC2
     ADDR1 and ADDR0 of ETROC2 are set on cover PCB of the module
       #+end_quote
     + This note, is, however, a remnant of a previous iteration of the design
       where all modules were on the same i2c bus. In the current configuration,
       each module has its own I2C bus, and shares the same address.
** Fusing Instructions
