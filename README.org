#+OPTIONS: ^:nil
#+EXPORT_EXCLUDE_TAGS: noexport
* CMS ETL Readout Board PCB
** Useful Links
- Latest ETL RB Schematics - [[https://gitlab.cern.ch/cms-etl-electronics/readout-board-pcb/uploads/5f85625e9218029a71266ea812cdf662/ETL_RB_09112020.PDF][ETL_RB_09112020.PDF]]
- Latest ETL RB Gerbers - [[https://gitlab.cern.ch/cms-etl-electronics/readout-board-pcb/uploads/cb704b1a3da9cfcdb0abcc41a2b6aaa6/quote_ETL_RB_09112020.zip][quote_ETL_RB_09112020.zip]]
- Mr. Wu's File Stash - [[http://physics.bu.edu/~wusx/download/ETL_RB/]]
- Datasheets:
  + LGPBT Manual - [[https://lpgbt.web.cern.ch/lpgbt/manual/][LpGBT Manual]]
  + GBT-SCA Manual - [[https://espace.cern.ch/GBT-Project/GBT-SCA/Manuals/GBT-SCA_Manual_2019.002.pdf][GBT-SCA Manual]]
  + LINPOL12 Datasheet - [[https://project-dcdc.web.cern.ch/public/Documents/linPOL12V%20datasheetV3.3.pdf][LinPOL12V]]
  + VTRX+ Application Note: [[https://edms.cern.ch/ui/file/2149674/1/VTRxPlusApplicationNote.pdf][VTRxPlusApplicationNote.pdf]]
  + VTRX+ Specification: [[https://edms.cern.ch/ui/file/1719329/1/VTRxPlus_spec_v2.4.pdf][VTRxPlus_spec_v2.4.pdf]]
  + VTRX+ LDD Specs: [[https://edms.cern.ch/ui/file/1719330/1/VLplus_quadLDD_spec_v1.2_prototypes.pdf][VLplus_quadLDD_spec_v1.2_prototypes.pdf]]
- TDR - [[https://cds.cern.ch/record/2667167/files/CMS-TDR-020.pdf][CMS-TDR-020]]
*** Relevant Presentations
- 2019/05/13 - [[https://indico.cern.ch/event/820512/contributions/3429658/attachments/1842929/3023621/ETL-Cabling-S_Los-May13-2019.pdf][Update on Power board and Patch Panel-0]] (Sergey V.)
- 2020/03/09 - [[https://indico.cern.ch/event/902328/contributions/3798257/attachments/2008611/3355343/2020-03-09_LV_scheme.pdf][ETL LV powering scheme]] (Natalia K.)
- 2020/04/05 - [[https://indico.cern.ch/event/906805/contributions/3815774/attachments/2016073/3369701/2020-04-05-ETL-RBv2-Boston.pdf][ETL Readout Board v2]] (Andy P.)
- 2020/04/27 - [[https://indico.cern.ch/event/912420/contributions/3837314/attachments/2026902/3391190/Andy_Liu_-_Emulator_v1.1.pdf][EIE Dataformat]] (Andy L.)
- 2020/06/02 - [[https://indico.cern.ch/event/931796/contributions/3915833/attachments/2061731/3458677/ETROC2-power-update-v1.pdf][ETROC Power consumption]] (Andy P.)
- 2020/07/13 - [[https://indico.cern.ch/event/939160/contributions/3946133/attachments/2073487/3481402/20200713_readout_board_interfaces.pdf][Readout Board Interfaces]] (Andy P.)
- 2020/08/31 - [[https://indico.cern.ch/event/950697/contributions/3993986/attachments/2093983/3519322/20200831_readout_board_v2.pptx.pdf][Readout Board v2 Update]] (Andy P.)
- 2020/08/31 - [[https://indico.cern.ch/event/950697/contributions/3993988/attachments/2094005/3519146/ETL-PowerConversion-S_Los-Aug31-2020.pdf][Power Board Status]] (Sergey V.)
** Milestones :noexport:
- 2020/XX/YY - Finish schematic and layout
- 2020/XX/YY - Submit files to fab house
** Block Diagrams
*** Data Flow
#+ATTR_HTML: :width 700px
[[file:docs/data-flow.png]]
*** Module Connectivity
Full size: [[file:docs/module-connectivity.pdf]]
#+ATTR_HTML: :width 700px
[[file:docs/module-connectivity.png]]
*** Power Distribution
#+ATTR_HTML: :width 700px
[[file:docs/power-distribution.png]]
*** Control and Monitoring
#+ATTR_HTML: :width 700px
[[file:docs/ctrl-and-mon.png]]
** Connectors/Interfaces
** Mechanical Outline
#+attr_org: :width 700px
[[file:docs/mechanical-outline.png]]
** Power
*** Power Estimates

The readout board is expected to dissipate up to ~1.3W, along with some additional power for LINPOL conversion efficiency. Total power should be around 2W.  Details of the calculation follow.

|-----------------------------+-------------|
| Note                        | P (mW)      |
|-----------------------------+-------------|
| 1.2V LPGBT analog + digital | 1000        |
| 1.2V VTRX digital           | 30          |
| 2.5V VTRX analog            | 150 - 175   |
| 1.5V GBT-SCA                | 65.4 - 108  |
| LINPOL12 Loss               | 613 - 853   |
|-----------------------------+-------------|
|                             | 1858 - 2166 |
|-----------------------------+-------------|

**** VTRX
[[https://edms.cern.ch/ui/file/1719329/1/VTRxPlus_spec_v2.4.pdf][VTRX+ Specification]] specifies:
- A supply current 2V5RX of 40mA
- A supply current 2V5TX of  15/ch @ End of life (30mA for a 2+1 configuration)
- A supply current 1V2D of 5+10/ch mA (25mA for a 2+1 configuration)

|---------+--------+--------+----------------------------------------|
| Voltage | I (mA) | P (mW) | Notes                                  |
|---------+--------+--------+----------------------------------------|
| 2V5RX   |     40 |    100 | 40mA total                             |
| 2V5TX   |     30 |     75 | 15mA/ch at end of life (10mA to start) |
| 1V2     |     25 |     30 | 5+10mA/ch                              |
|---------+--------+--------+----------------------------------------|
| Total   |        |  205mW |                                        |
|---------+--------+--------+----------------------------------------|

**** GBT-SCA
The GBT-SCA manual specifies power consumption of:

|--------------------------------+-------------------+-----------------|
| Supply                         | Typical (Maximum) | Power mW        |
|--------------------------------+-------------------+-----------------|
| 1V5 VDD core                   | 36 (63) mA        | 54 (94.5) mW    |
| 1V5 AVDD analog                | 0.5 (0.8) mA      | 0.75 (1.2) mW   |
| 1V5 DVDD Static supply current | 7.1 (8.2) mA      | 10.65 (12.3) mW |
|--------------------------------+-------------------+-----------------|
| Total                          | 43.6 (72.0) mA    | 65.4 (108.0) mW |
|--------------------------------+-------------------+-----------------|

**** LPGBT
LPGBT power measurements can be found at https://espace.cern.ch/GBT-Project/LpGBT/Presentations/lpGBT20190903.pdf

Note that these numbers may change between v0 and v1 of the LPGBT.

Power consumption is dependent on the exact configuration, but we expect it should be <500mW

We expect up to 2 LPGBTs per board, so ~1W maximum.

**** LINPOL

Three LINPOL12 chips are used on board to provide 1.5V (GBT-SCA), and 2.5V (1 each for VTRX TX + RX).

For the 2.5V supply a voltage divider is formed by RR0510P-1541-D (1.54k) and RR0510P-4870-D (487R).
 - V=0.6*(1+1540/487)=2.497V

For the 1.5V supply a voltage divider is formed by RR0510P-6040-D (604R) and RR0510P-4020-D (402R).
 - V= 0.6*(1+604/402)=1.50V

We have some additional power loss in the LINPOL12 chips, which is dependent on the exact input voltage. Assuming 8V nominal, we would expect using the /MAXIMUM/ values:

|--------+-------------------------------------------|
| Supply | Power mW                                  |
|--------+-------------------------------------------|
| 1V5    | (8-1.5)*(43.6 - 72) = (283 typ - 468 max) |
| 2V5 TX | (8-2.5)*(20 - 30) = (110 start - 165 EOL) |
| 2V5 RX | (8-2.5)*40 = 220                          |
|--------+-------------------------------------------|
| Total  | 613 - 853 mW                              |
|--------+-------------------------------------------|

** LPGBT Configuration

The DAQ and Trigger LPGBTs are arranged in a master-slave configuration, with the master LPGBT providing a clock and an I2C bus to the slave.

Both LPGBTs are configured by default in FEC12 10.24 Gbps mode, with jumpers available to select FEC5 or 5.12 Gbps modes. CHange of the mode affects both LPGBTs together.

A handy copy of the LPGBT mode table:
|------------+--------------+-------------+-------------|
| MODE [3:0] | Tx Data Rate | Tx Encoding | lpGBT Mode  |
|------------+--------------+-------------+-------------|
| 4’b0000    | 5 Gbps       | FEC5        | Off         |
| 4’b0001    | 5 Gbps       | FEC5        | Simplex TX  |
| 4’b0010    | 5 Gbps       | FEC5        | Simplex RX  |
| 4’b0011    | 5 Gbps       | FEC5        | Transceiver |
| 4’b0100    | 5 Gbps       | FEC12       | Off         |
| 4’b0101    | 5 Gbps       | FEC12       | Simplex TX  |
| 4’b0110    | 5 Gbps       | FEC12       | Simplex RX  |
| 4’b0111    | 5 Gbps       | FEC12       | Transceiver |
| 4’b1000    | 10 Gbps      | FEC5        | Off         |
| 4’b1001    | 10 Gbps      | FEC5        | Simplex TX  |
| 4’b1010    | 10 Gbps      | FEC5        | Simplex RX  |
| 4’b1011    | 10 Gbps      | FEC5        | Transceiver |
| 4’b1100    | 10 Gbps      | FEC12       | Off         |
| 4’b1101    | 10 Gbps      | FEC12       | Simplex TX  |
| 4’b1110    | 10 Gbps      | FEC12       | Simplex RX  |
| 4’b1111    | 10 Gbps      | FEC12       | Transceiver |
|------------+--------------+-------------+-------------|
** Pin Assignments
*** E-Link Assignments
**** DAQ Uplinks

All uplinks run at 320 or 640MHz

***** Sorted by ETROC
|------------+------------+-------|
| Assignment | Group/Link | Elink |
|------------+------------+-------|
| ETROC-0    | G5L0       |    20 |
| ETROC-1    | G5L2       |    22 |
| ETROC-2    | G0L0       |     0 |
| ETROC-3    | G0L2       |     2 |
| ETROC-4    | G4L0       |    16 |
| ETROC-5    | G4L2       |    18 |
| ETROC-6    | G1L0       |     4 |
| ETROC-7    | G1L2       |     6 |
| ETROC-8    | G3L0       |    12 |
| ETROC-9    | G3L2       |    14 |
| ETROC-10   | G2L0       |     8 |
| ETROC-11   | G2L2       |    10 |
|------------+------------+-------|

***** Sorted by E-link
|-------+------------+------------|
| Elink | Group/Link | Assignment |
|-------+------------+------------|
|     0 | G0L0       | ETROC-2    |
|     1 | G0L1       | --         |
|     2 | G0L2       | ETROC-3    |
|     3 | G0L3       | --         |
|     4 | G1L0       | ETROC-6    |
|     5 | G1L1       | --         |
|     6 | G1L2       | ETROC-7    |
|     7 | G1L3       | --         |
|     8 | G2L0       | ETROC-10   |
|     9 | G2L1       | --         |
|    10 | G2L2       | ETROC-11   |
|    11 | G2L3       | --         |
|    12 | G3L0       | ETROC-8    |
|    13 | G3L1       | --         |
|    14 | G3L2       | ETROC-9    |
|    15 | G3L3       | --         |
|    16 | G4L0       | ETROC-4    |
|    17 | G4L1       | --         |
|    18 | G4L2       | ETROC-5    |
|    19 | G4L3       | --         |
|    20 | G5L0       | ETROC-0    |
|    21 | G5L1       | --         |
|    22 | G5L2       | ETROC-1    |
|    23 | G5L3       | --         |
|    24 | G6L0       | --         |
|    25 | G6L1       | --         |
|    26 | G6L2       | --         |
|    27 | G6L3       | --         |
|-------+------------+------------|
**** Trigger Uplinks

All uplinks run at 320 or 640MHz

***** Sorted by ETROC
|------------+------------+-------|
| Assignment | Group/Link | Elink |
|------------+------------+-------|
| ETROC-0    | G5L2       |    22 |
| ETROC-1    | G5L0       |    20 |
| ETROC-2    | G0L2       |     2 |
| ETROC-3    | G0L0       |     0 |
| ETROC-4    | G4L2       |    18 |
| ETROC-5    | G4L0       |    16 |
| ETROC-6    | G1L2       |     6 |
| ETROC-7    | G1L0       |     4 |
| ETROC-8    | G3L2       |    14 |
| ETROC-9    | G3L0       |    12 |
| ETROC-10   | G2L2       |    10 |
| ETROC-11   | G2L0       |     8 |
|------------+------------+-------|

***** Sorted by E-link
|-------+------------+------------|
| Elink | Group/Link | Assignment |
|-------+------------+------------|
|     0 | G0L0       | ETROC-3    |
|     1 | G0L1       | --         |
|     2 | G0L2       | ETROC-2    |
|     3 | G0L3       | --         |
|     4 | G1L0       | ETROC-7    |
|     5 | G1L1       | --         |
|     6 | G1L2       | ETROC-6    |
|     7 | G1L3       | --         |
|     8 | G2L0       | ETROC-11   |
|     9 | G2L1       | --         |
|    10 | G2L2       | ETROC-10   |
|    11 | G2L3       | --         |
|    12 | G3L0       | ETROC-9    |
|    13 | G3L1       | --         |
|    14 | G3L2       | ETROC-8    |
|    15 | G3L3       | --         |
|    16 | G4L0       | ETROC-5    |
|    17 | G4L1       | --         |
|    18 | G4L2       | ETROC-4    |
|    19 | G4L3       | --         |
|    20 | G5L0       | ETROC-1    |
|    21 | G5L1       | --         |
|    22 | G5L2       | ETROC-0    |
|    23 | G5L3       | --         |
|    24 | G6L0       | --         |
|    25 | G6L1       | --         |
|    26 | G6L2       | --         |
|    27 | G6L3       | --         |
|-------+------------+------------|
**** Downlink

All downlinks run at 320MHz

|------------+-------+-------------|
| Group/Link | Elink | Assignment  |
|------------+-------+-------------|
| G0L0       |     0 | ETROC-2/3   |
| G0L1       |     1 | --          |
| G0L2       |     2 | ETROC-6/7   |
| G0L3       |     3 | --          |
| G1L0       |     4 | ETROC-10/11 |
| G1L1       |     5 | --          |
| G1L2       |     6 | --          |
| G1L3       |     7 | --          |
| G2L0       |     8 | ETROC-8/9   |
| G2L1       |     9 | --          |
| G2L2       |    10 | ETROC-4/5   |
| G2L3       |    11 | --          |
| G3L0       |    12 | ETROC-0/1   |
| G3L1       |    13 | --          |
| G3L2       |    14 | --          |
| G3L3       |    15 | --          |
|------------+-------+-------------|

*** Clock Assignments
|-------+-------------+------|
| Clock | Assignment  | Freq |
|-------+-------------+------|
|     0 | ETROC-3     | 40M  |
|     1 | ETROC-2     | 40M  |
|     2 | ETROC-6     | 40M  |
|     3 | ETROC-7     | 40M  |
|     4 | ETROC-10    | 40M  |
|     5 | ETROC-11    | 40M  |
|     6 | --          | OFF  |
|     7 | --          | OFF  |
|     8 | --          | OFF  |
|     9 | --          | OFF  |
|    10 | --          | OFF  |
|    11 | Slave Clock | 40M  |
|    12 | --          | OFF  |
|    13 | --          | OFF  |
|    14 | --          | OFF  |
|    15 | --          | OFF  |
|    16 | --          | OFF  |
|    17 | --          | OFF  |
|    18 | --          | OFF  |
|    19 | --          | OFF  |
|    20 | --          | OFF  |
|    21 | --          | OFF  |
|    22 | ETROC-9     | 40M  |
|    23 | ETROC-4     | 40M  |
|    24 | ETROC-8     | 40M  |
|    25 | ETROC-5     | 40M  |
|    26 | ETROC-0     | 40M  |
|    27 | ETROC-1     | 40M  |
|-------+-------------+------|
*** LPGBT Pin Assignments
**** Analog Inputs
**** GPIO
*** SCA Pin Assignments
**** Analog Inputs
**** GPIO
** Jumpers
|---------+--------------------------------------------------------|
| Jumpers | Description                                            |
|---------+--------------------------------------------------------|
| JMP1    | Install to set LPGBT MODE[2] to 0 (FEC12 → FEC5)       |
| JMP2    | Install to set LPGBT MODE[3] to 0 (data rate → 5 Gbps) |
|---------+--------------------------------------------------------|

Locations:

** Test points

** VTRX+ I2C
VTRX+ documentation does not specify the I2C address of the device, but the laser driver spec has some details: https://edms.cern.ch/ui/file/1719330/1/VLplus_quadLDD_spec_v1.2_prototypes.pdf

I checked the bonding diagram (https://edms.cern.ch/ui/file/2146792/1/CERN_VTRxPlus_V10_bonding.pdf) and the address pins are not connected, so they use internal pull down.

The address then is 1010000 = 0x50

** Errata
